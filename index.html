<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Minesweeper — Avoid the Mines</title>
  <style>
    :root{
      /* Light (default) */
      --bg:#f6f8ff; --panel:#ffffff; --panel-2:#f1f5ff; --text:#0f172a; --muted:#64748b;
      --accent:#2563eb; --accent-2:#7c3aed; --danger:#ef4444; --ok:#16a34a; --warning:#f59e0b;
      --cell-unrevealed:#e7ecff; --cell-unrevealed-top:#eef2ff; --cell-revealed:#ffffff; --cell-revealed-edge:#c7d2fe; --cell-flag:#fff7cc;
      --grid-gap:4px;
    }
    body.theme-dark{
      --bg:#0b1020; --panel:#0e152b; --panel-2:#121a36; --text:#e8ecf3; --muted:#93a4c1;
      --accent:#5b7cfa; --accent-2:#7fa0ff; --danger:#ff5c6a; --ok:#37d683; --warning:#f8b84a;
      --cell-unrevealed:#0a0f22; --cell-unrevealed-top:#0f1a39; --cell-revealed:#22315f; --cell-revealed-edge:#38539d; --cell-flag:#1c2a58;
    }
    body.theme-colorful{
      /* JS will set tile colors per game (single hue for all tiles) */
      --bg:#fff7fb; --panel:#ffffff; --panel-2:#fff0f5; --text:#111827; --muted:#6b7280;
      --accent:#e11d48; --accent-2:#7c3aed; --danger:#ef4444; --ok:#10b981; --warning:#f59e0b;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg, var(--panel-2), var(--bg) 60%); color:var(--text);
         font:14px/1.35 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
         display:flex; align-items:center; justify-content:center; padding:24px; overflow-x:hidden}
    .app{width:min(1000px, 96vw); margin:0 auto}
    .card{background:var(--panel); border:1px solid rgba(0,0,0,.08); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(31,41,55,.08)}

    .header{display:grid; grid-template-columns:minmax(0,1fr) auto auto auto; column-gap:10px; align-items:center;
            position:sticky; top:0; background:var(--panel); z-index:5; padding-bottom:8px; margin-bottom:12px}
    .left,.right{display:flex; gap:10px; align-items:center; min-width:0}
    .left{flex:1}
    .brand-chip{display:inline-flex; align-items:center; gap:8px; background:linear-gradient(90deg, var(--panel-2), var(--panel));
                padding:8px 12px; border:1px solid rgba(0,0,0,.08); border-radius:12px; font-weight:800; white-space:nowrap}
    .brand-chip .sub{font-weight:600; color:var(--muted); letter-spacing:.2px}

    .modes{display:flex; background:var(--panel-2); border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:4px}
    .seg-btn{appearance:none; border:0; background:transparent; padding:6px 10px; border-radius:8px; cursor:pointer; white-space:nowrap}
    .seg-btn[aria-pressed="true"]{background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.02), 0 0 0 1px rgba(0,0,0,.06) inset}
    .seg-btn .title{font-weight:700}
    .seg-btn .meta{display:block; font-size:11px; color:var(--muted)}

    .button{background:var(--panel-2); color:var(--text); border:1px solid rgba(0,0,0,.08); border-radius:10px; padding:8px 12px; display:inline-flex; align-items:center; gap:8px; cursor:pointer}
    .button:active{transform:translateY(1px)}
    .stats{display:flex; gap:8px}
    .stat{background:#fff; padding:6px 10px; border-radius:10px; border:1px solid rgba(0,0,0,.08)}
    .stat .label{color:var(--muted); font-size:11px}
    .stat .value{font-weight:800; letter-spacing:.5px}

    .grid-wrap{background:var(--panel); border:1px solid rgba(0,0,0,.08); border-radius:14px; padding:12px}
    #board{display:grid; gap:var(--grid-gap); justify-content:center; touch-action:manipulation}

    .cell{width:32px; height:32px; display:grid; place-items:center; font-weight:800; border-radius:8px; user-select:none;
          transition:transform .02s ease, background .15s ease, box-shadow .15s ease, border-color .15s ease; font-size:16px}
    .cell.hidden{background:linear-gradient(180deg, var(--cell-unrevealed-top, #eef2ff), var(--cell-unrevealed, #e7ecff));
                 border:1px solid var(--cell-revealed-edge, #c7d2fe); box-shadow:inset 0 2px 0 rgba(255,255,255,.9), inset 0 -2px 0 rgba(129,140,248,.25); cursor:pointer}
    .cell.hidden:hover{outline:2px solid rgba(124,58,237,.25)}
    .cell.hidden:active{transform:translateY(1px)}
    .cell.revealed{background:linear-gradient(180deg, var(--cell-revealed, #ffffff), var(--bg)); border:1px solid var(--cell-revealed-edge, #c7d2fe)}
    .cell.flagged{background:linear-gradient(180deg, var(--cell-flag), #fff2b3); outline:2px solid var(--warning)}
    .cell.mine.revealed{background:linear-gradient(180deg,#ffe2e2,#ffd2d2); border-color:#fecaca}

    .n1{color:var(--n1, #2563eb)}
    .n2{color:var(--n2, #16a34a)}
    .n3{color:var(--n3, #dc2626)}
    .n4{color:var(--n4, #7c3aed)}
    .n5{color:#b45309}
    .n6{color:#0891b2}
    .n7{color:#be185d}
    .n8{color:#374151}

    .footer{margin-top:10px; color:var(--muted); font-size:12px; text-align:center}

    .modal-backdrop{position:fixed; inset:0; background:rgba(15,23,42,.35); display:none; align-items:center; justify-content:center}
    .modal{background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:16px; padding:20px; width:min(420px, 92vw); box-shadow:0 20px 60px rgba(0,0,0,.18)}
    .modal h3{margin:0 0 8px 0; font-size:18px}
    .modal p{margin:0 0 16px 0; color:#4b5563}
    .modal .actions{display:flex; gap:8px; justify-content:flex-end}
    .modal .actions .button{background:var(--panel-2)}

    @media (max-width:900px){ .brand-chip{display:none} }
    @media (max-width:760px){ .stats .label{display:none} .seg-btn{padding:4px 6px} .seg-btn .meta{display:none} }
    @media (max-width:620px){ .seg-btn .title{font-size:12px} #reset{padding:6px 8px; font-size:12px} }
    @media (max-width:560px){ .stats{display:none} }
    @media (max-width:600px){ .cell{width:28px; height:28px; font-size:14px} }
  </style>
</head>
<body>
  <div class="app card">
    <div class="header">
      <div class="left">
        <div class="brand-chip">Minesweeper<span class="sub">Avoid the Mines</span></div>
        <div class="modes" role="tablist" aria-label="Difficulty">
          <button class="seg-btn mode-btn" role="tab" data-mode="beginner" aria-pressed="true">
            <span class="title">Beginner</span>
            <span class="meta">8×8 • 10</span>
          </button>
          <button class="seg-btn mode-btn" role="tab" data-mode="intermediate" aria-pressed="false">
            <span class="title">Intermediate</span>
            <span class="meta">12×10 • 22</span>
          </button>
          <button class="seg-btn mode-btn" role="tab" data-mode="expert" aria-pressed="false">
            <span class="title">Expert</span>
            <span class="meta">16×12 • 40</span>
          </button>
        </div>
      </div>
      <div class="right">
        <div class="modes" role="tablist" aria-label="Theme">
          <button class="seg-btn theme-btn" data-theme="light" aria-pressed="true">Light</button>
          <button class="seg-btn theme-btn" data-theme="dark" aria-pressed="false">Dark</button>
          <button class="seg-btn theme-btn" data-theme="colorful" aria-pressed="false">Color</button>
        </div>
        <div class="stats">
          <div class="stat"><div class="label">Mines</div><div id="mineCount" class="value">000</div></div>
          <div class="stat"><div class="label">Flags</div><div id="flagsLeft" class="value">000</div></div>
          <div class="stat"><div class="label">Time</div><div id="time" class="value">000</div></div>
        </div>
        <button id="reset" class="button">New game</button>
      </div>
    </div>

    <div class="grid-wrap">
      <div id="board"></div>
    </div>

    <div id="resultModal" class="modal-backdrop" role="dialog" aria-modal="true">
      <div class="modal">
        <h3 id="modalTitle">Game Over</h3>
        <p id="modalText">You hit a mine.</p>
        <div class="actions">
          <button id="btnAgain" class="button">Play again</button>
          <button id="btnChange" class="button">Change difficulty</button>
        </div>
      </div>
    </div>

    <div class="footer">Left-click to reveal • Right-click to flag • Boards are generated to be solvable by logic (no guesses) • Avoid the mines</div>
  </div>

  <script>
    // ------- helpers & DOM -------
    const el = (sel) => document.querySelector(sel);
    const els = (sel) => Array.from(document.querySelectorAll(sel));
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    // ------- icons (mine & flag) -------
    const Icon = {
      // simple "naval mine" / spiky bomb glyph
      mine: () => {
        const danger = getComputedStyle(document.documentElement).getPropertyValue('--danger').trim() || '#ef4444';
        return `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <g fill="none" stroke="${danger}" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5.5" fill="${danger}22"/>
            <path d="M12 2v4M12 18v4M2 12h4M18 12h4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M19.07 4.93l-2.83 2.83M7.76 16.24l-2.83 2.83"/>
            <circle cx="10" cy="10" r="0.6" fill="${danger}"/>
            <circle cx="14" cy="10" r="0.6" fill="${danger}"/>
            <path d="M9.5 13.2c1.7 1.2 3.3 1.2 5 0"/>
          </g>
        </svg>`;
      },
      flag: () => `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M6 21V4m0 0h9l-2 3 2 3H6" fill="${getComputedStyle(document.documentElement).getPropertyValue('--warning').trim()}" stroke="#b45309" stroke-width="1.5" stroke-linejoin="round"/>
        </svg>`
    };

    // ------- solver (single-point rules) -------
    function solveDeterministically(sim){
      let changed = true; let progress = false;
      while(changed){
        changed = false;
        for(let y=0;y<sim.h;y++){
          for(let x=0;x<sim.w;x++){
            const c = sim.cells[y][x];
            if(!c.revealed || c.adj <= 0) continue;
            let hidden=[]; let flagged=0;
            for(let ny=Math.max(0,y-1); ny<=Math.min(sim.h-1,y+1); ny++){
              for(let nx=Math.max(0,x-1); nx<=Math.min(sim.w-1,x+1); nx++){
                if(nx===x && ny===y) continue;
                const n = sim.cells[ny][nx];
                if(!n.revealed && !n.flagged) hidden.push([nx,ny]);
                if(n.flagged) flagged++;
              }
            }
            if(flagged === c.adj && hidden.length){
              hidden.forEach(([sx,sy])=>{ const s=sim.cells[sy][sx]; if(!s.revealed && !s.flagged){ s.revealed=true; progress=true; changed=true; }});
            }
            if(c.adj - flagged === hidden.length && hidden.length){
              hidden.forEach(([fx,fy])=>{ const s=sim.cells[fy][fx]; if(!s.flagged){ s.flagged=true; progress=true; changed=true; }});
            }
          }
        }
      }
      for(let y=0;y<sim.h;y++) for(let x=0;x<sim.w;x++){ const c = sim.cells[y][x]; if(!c.mine && !c.revealed) return {solved:false, progress}; }
      return {solved:true, progress};
    }
    function cloneBoard(src){
      const sim = {w:src.w,h:src.h,cells:[]};
      for(let y=0;y<src.h;y++){
        sim.cells[y] = [];
        for(let x=0;x<src.w;x++){
          const c = src.cells[y][x];
          sim.cells[y][x] = {mine:c.mine, adj:c.adj, revealed:c.revealed, flagged:c.flagged};
        }
      }
      return sim;
    }

    // ------- game -------
    class Minesweeper {
      constructor(boardEl){
        this.boardEl = boardEl;
        this.timer = null; this.time = 0;
        this.firstReveal = true; this.ended = false;
        this.cells = []; this.w = 9; this.h = 9; this.mines = 10;
        this._bindGlobalContextMenu();
      }
      newGame({w,h,mines}){
        const y = window.scrollY; // preserve scroll position
        if(document.body.classList.contains('theme-colorful')) randomizeColorfulPalette();
        this.w = w; this.h = h; this.mines = Math.min(mines, w*h-1);
        this.firstReveal = true; this.ended = false; this.time = 0; this._stopTimer(); this._updateTime();
        this._buildEmpty(); this._render(); this._updateCounts();
        window.scrollTo(0, y);
      }
      _buildEmpty(){
        this.cells = Array.from({length:this.h}, () => Array.from({length:this.w}, () => ({ mine:false, adj:0, revealed:false, flagged:false })));
      }
      _placeMinesNoGuess(excludeX, excludeY){
        const MAX_TRIES = 300;
        for(let attempt=0; attempt<MAX_TRIES; attempt++){
          this.cells.forEach(row=>row.forEach(c=>{c.mine=false; c.adj=0; c.revealed=false; c.flagged=false;}));
          let placed = 0; while(placed < this.mines){
            const x = Math.floor(Math.random()*this.w);
            const y = Math.floor(Math.random()*this.h);
            if ((x===excludeX && y===excludeY) || this.cells[y][x].mine) continue;
            this.cells[y][x].mine = true; placed++;
          }
          for(let y=0;y<this.h;y++){
            for(let x=0;x<this.w;x++){
              if (this.cells[y][x].mine) { this.cells[y][x].adj = -1; continue; }
              let c=0; this._forEachNeighbor(x,y,(nx,ny)=>{ if(this.cells[ny][nx].mine) c++; });
              this.cells[y][x].adj = c;
            }
          }
          const sim = cloneBoard(this);
          if(sim.cells[excludeY][excludeX].mine) continue; // safety
          const stack=[[excludeX,excludeY]]; const visited=new Set();
          while(stack.length){
            const [cx,cy]=stack.pop(); const key=cx+','+cy; if(visited.has(key)) continue; visited.add(key);
            const c=sim.cells[cy][cx]; c.revealed=true;
            if(c.adj===0){ this._forEachNeighbor(cx,cy,(nx,ny)=>{ const n=sim.cells[ny][nx]; if(!n.revealed && !n.flagged && !n.mine) stack.push([nx,ny]); }); }
          }
          const res = solveDeterministically(sim);
          if(res.solved){ return true; }
        }
        return false;
      }
      _placeMines(excludeX, excludeY){
        if(this._placeMinesNoGuess(excludeX, excludeY)) return;
        let placed = 0; const total = this.mines;
        while(placed < total){
          const x = Math.floor(Math.random()*this.w);
          const y = Math.floor(Math.random()*this.h);
          if ((x===excludeX && y===excludeY) || this.cells[y][x].mine) continue;
          this.cells[y][x].mine = true; placed++;
        }
        for(let y=0;y<this.h;y++){
          for(let x=0;x<this.w;x++){
            if (this.cells[y][x].mine) { this.cells[y][x].adj = -1; continue; }
            let c=0; this._forEachNeighbor(x,y,(nx,ny)=>{ if(this.cells[ny][nx].mine) c++; });
            this.cells[y][x].adj = c;
          }
        }
      }
      _forEachNeighbor(x,y,cb){
        for(let dy=-1; dy<=1; dy++){
          for(let dx=-1; dx<=1; dx++){
            if(dx===0 && dy===0) continue;
            const nx=x+dx, ny=y+dy;
            if(nx>=0 && nx<this.w && ny>=0 && ny<this.h) cb(nx,ny);
          }
        }
      }
      _render(){
        const sizePx = this._cellSize();
        this.boardEl.style.gridTemplateColumns = `repeat(${this.w}, ${sizePx}px)`;
        this.boardEl.innerHTML = '';
        for(let y=0;y<this.h;y++){
          for(let x=0;x<this.w;x++){
            const div = document.createElement('div');
            div.className = 'cell hidden';
            div.dataset.x = String(x); div.dataset.y = String(y);
            div.addEventListener('click', (e)=> this._onLeftClick(e, x, y));
            div.addEventListener('contextmenu', (e)=> this._onRightClick(e, x, y));
            this.boardEl.appendChild(div);
          }
        }
        this._draw();
      }
      _cellSize(){
        const maxW = Math.min(900, window.innerWidth*0.9 - 40);
        const cell = Math.floor(maxW / this.w) - 2;
        return clamp(cell, 22, 38);
      }
      _inBounds(x,y){ return x>=0 && x<this.w && y>=0 && y<this.h; }
      _onLeftClick(e, x, y){
        if(this.ended) return;
        if(!this._inBounds(x,y)) return;
        const cell = this.cells[y] && this.cells[y][x];
        if(!cell) return;
        if(cell.flagged || cell.revealed) return;
        if(this.firstReveal){ this._placeMines(x,y); this.firstReveal = false; this._startTimer(); }
        if(cell.mine){ this._revealAll(); this.ended = true; this._stopTimer(); this._draw(); this._showModal('Game Over', 'You hit a mine.'); return; }
        this._reveal(x,y); this._draw();
        if(this._checkWin()){
          this.ended = true; this._stopTimer(); fireConfetti(1800, 140); this._showModal('Cleared!', `No mines hit. Cleared in ${this.time}s.`);
        }
      }
      _onRightClick(e, x, y){ e.preventDefault(); if(this.ended) return; if(!this._inBounds(x,y)) return; const cell = this.cells[y] && this.cells[y][x]; if(!cell || cell.revealed) return; cell.flagged = !cell.flagged; this._updateCounts(); this._drawCell(x,y); }
      _reveal(x,y){
        const stack=[[x,y]]; const visited=new Set();
        while(stack.length){
          const [cx,cy] = stack.pop();
          if(!this._inBounds(cx,cy)) continue;
          const key = cx+','+cy; if(visited.has(key)) continue; visited.add(key);
          const c = this.cells[cy] && this.cells[cy][cx];
          if(!c || c.flagged || c.revealed) continue; c.revealed = true;
          if(c.adj===0){ this._forEachNeighbor(cx,cy,(nx,ny)=>{ const n = this.cells[ny][nx]; if(!n.revealed && !n.flagged && !n.mine) stack.push([nx,ny]); }); }
        }
      }
      _revealAll(){ for(let y=0;y<this.h;y++){ for(let x=0;x<this.w;x++){ this.cells[y][x].revealed = true; } } }
      _checkWin(){ for(let y=0;y<this.h;y++){ for(let x=0;x<this.w;x++){ const c=this.cells[y][x]; if(!c.mine && !c.revealed) return false; } } return true; }
      _updateCounts(){
        let flagsUsed = 0;
        for(let y=0;y<this.h;y++) for(let x=0;x<this.w;x++){ if(this.cells[y][x].flagged) flagsUsed++; }
        el('#mineCount').textContent = String(this.mines).padStart(3,'0');
        el('#flagsLeft').textContent = String(Math.max(0, this.mines - flagsUsed)).padStart(3,'0');
      }
      _startTimer(){ if(this.timer) return; this.timer = setInterval(()=>{ this.time++; this._updateTime(); }, 1000); }
      _stopTimer(){ if(this.timer){ clearInterval(this.timer); this.timer=null; } }
      _updateTime(){ el('#time').textContent = String(this.time).padStart(3,'0'); }
      _draw(){ for(let y=0;y<this.h;y++){ for(let x=0;x<this.w;x++) this._drawCell(x,y); } }
      _drawCell(x,y){
        const idx = y*this.w + x; const div = this.boardEl.children[idx];
        if(!div) return;
        const c = this.cells[y][x];
        div.className = 'cell ' + (c.revealed ? 'revealed' : 'hidden') + (c.flagged ? ' flagged' : '') + (c.mine && c.revealed ? ' mine' : '');
        if(c.revealed){
          if(c.mine){ div.innerHTML = Icon.mine(); }
          else if(c.adj>0){ div.textContent = c.adj; div.classList.add('n'+c.adj); }
          else { div.textContent = ''; }
        } else { div.innerHTML = c.flagged ? Icon.flag() : ''; }
      }
      _bindGlobalContextMenu(){ this.boardEl.addEventListener('contextmenu',(e)=>{ e.preventDefault(); }); }
      _showModal(title, text){ el('#modalTitle').textContent = title; el('#modalText').textContent = text; el('#resultModal').style.display = 'flex'; }
      _hideModal(){ el('#resultModal').style.display = 'none'; }
    }

    const board = el('#board');
    const game = new Minesweeper(board);

    const MODE_CONFIG = {
      beginner: {w:8,h:8,mines:10},
      intermediate: {w:12,h:10,mines:22},
      expert: {w:16,h:12,mines:40}
    };

    function applyMode(mode){
      const cfg = MODE_CONFIG[mode];
      if(!cfg){ console.error('Unknown mode', mode); return; }
      const y = window.scrollY;
      els('.mode-btn').forEach(b=> b.setAttribute('aria-pressed', String(b.dataset.mode===mode)) );
      if(document.body.classList.contains('theme-colorful')) { randomizeColorfulPalette(); }
      game.newGame(cfg);
      window.scrollTo(0, y);
    }

    els('.mode-btn').forEach(btn=>{
      btn.addEventListener('click', ()=> applyMode(btn.dataset.mode));
    });

    // ------- theme handling -------
    function hsl(h,s,l){return `hsl(${h} ${s}% ${l}%)`}
    function random(min,max){return Math.floor(Math.random()*(max-min+1))+min}
    function randomizeColorfulPalette(){
      const base = random(0,359);
      const panelTint = (base+320)%360;
      const root = document.documentElement.style;
      root.setProperty('--cell-unrevealed', hsl(panelTint, 95, 92));
      root.setProperty('--cell-unrevealed-top', hsl(panelTint, 100, 96));
      root.setProperty('--cell-revealed-edge', hsl(panelTint, 60, 70));
      root.setProperty('--panel-2', hsl(panelTint, 60, 96));
      root.setProperty('--n1', hsl((base+0)%360, 70, 40));
      root.setProperty('--n2', hsl((base+100)%360, 60, 38));
      root.setProperty('--n3', hsl((base+200)%360, 65, 40));
      root.setProperty('--n4', hsl((base+280)%360, 55, 45));
    }

    function setLightPalette(){
      const root = document.documentElement.style;
      root.setProperty('--cell-unrevealed', '#e7ecff');
      root.setProperty('--cell-unrevealed-top', '#eef2ff');
      root.setProperty('--cell-revealed-edge', '#c7d2fe');
      root.setProperty('--panel-2', '#f1f5ff');
      root.setProperty('--n1', '#2563eb');
      root.setProperty('--n2', '#16a34a');
      root.setProperty('--n3', '#dc2626');
      root.setProperty('--n4', '#7c3aed');
    }

    function applyTheme(theme){
      document.body.classList.remove('theme-light','theme-dark','theme-colorful');
      if(theme==='dark'){
        document.body.classList.add('theme-dark');
      } else if(theme==='colorful') {
        document.body.classList.add('theme-colorful');
        randomizeColorfulPalette();
      } else {
        document.body.classList.add('theme-light');
        setLightPalette();
      }
      els('.theme-btn').forEach(b=> b.setAttribute('aria-pressed', String(b.dataset.theme===theme)) );
      if(game && game._draw) game._draw();
    }

    els('.theme-btn').forEach(btn=> btn.addEventListener('click', ()=> applyTheme(btn.dataset.theme)) );

    el('#reset').addEventListener('click', ()=>{
      const y = window.scrollY;
      const active = els('.mode-btn').find(b=>b.getAttribute('aria-pressed')==='true')?.dataset.mode || 'beginner';
      applyMode(active);
      window.scrollTo(0, y);
    });

    el('#btnAgain').addEventListener('click', ()=>{ game._hideModal(); el('#reset').click(); });
    el('#btnChange').addEventListener('click', ()=>{ game._hideModal(); });
    window.addEventListener('resize', ()=> game._render());

    // --- modal: close on backdrop click & Esc ---
    const __modalBackdrop = document.querySelector('#resultModal');
    if(__modalBackdrop){ __modalBackdrop.addEventListener('click', (e)=>{ if(e.target === __modalBackdrop) game._hideModal(); }); }
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && __modalBackdrop && __modalBackdrop.style.display === 'flex') game._hideModal(); });

    // --- simple confetti ---
    function fireConfetti(duration=1500, count=120){
      try{
        const canvas = document.createElement('canvas');
        canvas.className = 'confetti-canvas';
        Object.assign(canvas.style,{position:'fixed',inset:'0',pointerEvents:'none',zIndex:9999});
        document.body.appendChild(canvas);
        const ctx = canvas.getContext('2d');
        let W = canvas.width = window.innerWidth;
        let H = canvas.height = window.innerHeight;
        const parts = Array.from({length:count}, ()=>({
          x: Math.random()*W,
          y: -20 - Math.random()*H,
          r: 3 + Math.random()*4,
          vx: -1 + Math.random()*2,
          vy: 2 + Math.random()*3,
          color: `hsl(${Math.random()*360} 80% 60%)`
        }));
        let start=null;
        function tick(ts){
          if(!start) start = ts;
          const t = ts - start;
          ctx.clearRect(0,0,W,H);
          for(const p of parts){ p.x += p.vx; p.y += p.vy; p.vy += 0.02; ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); }
          if(t < duration){ requestAnimationFrame(tick); } else { canvas.remove(); }
        }
        requestAnimationFrame(tick);
        const onResize = ()=>{ W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; };
        window.addEventListener('resize', onResize, {once:true});
      }catch(err){ console.warn('Confetti unavailable:', err); }
    }

    // ------- init (Beginner + Light by default) -------
    document.addEventListener('DOMContentLoaded', ()=>{
      applyTheme('light');
      applyMode('beginner');
    });

    // ------- tests (updated) -------
    (function selfTests(){
      console.groupCollapsed('Minesweeper self-tests');
      try{
        applyMode('beginner');
        const cellDomCount = el('#board').children.length;
        console.assert(cellDomCount === game.w*game.h, `DOM cells (${cellDomCount}) should equal w*h (${game.w*game.h})`);
        console.assert(typeof game._showModal === 'function', '_showModal should be a function');
        game._showModal('Test', 'Modal OK'); game._hideModal();
        game._onLeftClick(new Event('click'), -1, -1);
        game._onRightClick(new Event('contextmenu'), 999, 999);
        fireConfetti(100, 10);
        game._showModal('Test', 'Press Esc');
        const evt = new KeyboardEvent('keydown', {key:'Escape'});
        window.dispatchEvent(evt);
        console.assert(el('#resultModal').style.display !== 'flex', 'Modal should close on Esc');
      }catch(e){ console.error('Self-tests failed:', e); }
      console.groupEnd();
    })();
  </script>
</body>
</html>
